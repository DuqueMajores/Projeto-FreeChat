<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FreeChat</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* regras pequenas necess√°rias localmente */
    .msg {
      margin: 8px 0;
    }

    .hidden {
      display: none !important;
    }

    .msg-text a {
      color: inherit;
    }
  </style>
</head>

<body>
  <header>
    <h2>FreeChat</h2>
    <h5>Escreva o que quiser</h5>
    <h5>Encontre o que precisa</h5>
  </header>

  <!-- Pesquisa -->
  <form id="search-form" role="search">
    <input type="search" name="pesquisa" id="pesquisa" placeholder="O que voc√™ procura?" title="Campo de pesquisa"
      autocomplete="off">
  </form>

  <!-- Caixa do chat -->
  <div id="chat-box" aria-live="polite"></div>

  <!-- Envio de mensagens -->
  <form id="chat-form">
    <input type="text" name="mensagem" id="mensagem" placeholder="Mostre para o mundo!" title="Campo de mensagem"
      autocomplete="off">
    <button type="submit">Enviar</button>
  </form>

  <!-- Ranking -->
  <div id="ranking-box">
    <h3>üî• Top 5 Mensagens</h3>
    <ul id="ranking-list"></ul>
  </div>

  <footer>
    FreeChat - 2025
  </footer>

  <script>
    // Refer√™ncias DOM
    const chatForm = document.getElementById("chat-form");
    const chatBox = document.getElementById("chat-box");
    const inputMensagem = document.getElementById("mensagem");
    const searchForm = document.getElementById("search-form");
    const inputPesquisa = document.getElementById("pesquisa");
    const rankingList = document.getElementById("ranking-list");

    // Estado simples
    let currentSearchTerm = "";

    // Normaliza texto (minusculo + remove acentos) ‚Äî com fallback
    function normalizeText(s) {
      if (!s) return "";
      try {
        return s.toString().toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu, '').trim();
      } catch (err) {
        // Fallback se \p{Diacritic} n√£o suportado
        return s.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').trim();
      }
    }

    // Fun√ß√£o para detectar links, n√∫meros, e-mails e @usuario
    function formatarMensagem(texto) {
      if (!texto) return "";
      let t = texto;
      // URLs
      t = t.replace(/(https?:\/\/[^\s]+|www\.[^\s]+)/gi, function (match) {
        let url = match;
        if (!url.startsWith("http")) url = "http://" + url;
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${match}</a>`;
      });
      // Telefones (10 ou 11 d√≠gitos) -> WhatsApp
      t = t.replace(/\b(\d{10,11})\b/g, function (match) {
        return `<a href="https://wa.me/55${match}" target="_blank" rel="noopener noreferrer">${match}</a>`;
      });
      // E-mails
      t = t.replace(/\b[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}\b/gi, function (match) {
        return `<a href="mailto:${match}">${match}</a>`;
      });
      // Men√ß√µes @usuario (Instagram)
      t = t.replace(/(^|\s)@([a-zA-Z0-9._-]+)/g, function (match, space, user) {
        return `${space}<a href="https://instagram.com/${user}" target="_blank" rel="noopener noreferrer">@${user}</a>`;
      });
      return t;
    }

    // Renderiza mensagens obtidas do backend de forma segura (criando elementos)
    async function carregarMensagens() {
      try {
        const resp = await fetch("/messages");
        const dados = await resp.json();
        chatBox.innerHTML = ""; // limpar

        dados.forEach(msg => {
          const wrapper = document.createElement("div");
          wrapper.className = "msg";

          const textDiv = document.createElement("div");
          textDiv.className = "msg-text";
          textDiv.innerHTML = formatarMensagem(msg.text);

          const footer = document.createElement("div");
          footer.className = "msg-footer";
          footer.style.display = "flex";
          footer.style.justifyContent = "flex-end";

          const likeBtn = document.createElement("button");
          likeBtn.className = "like-btn";
          likeBtn.type = "button";
          likeBtn.dataset.id = msg.id;

          // Troca de emoji conforme usu√°rio j√° curtiu
          if (msg.userLiked) {
            likeBtn.textContent = `‚ù§Ô∏è ${msg.likes}`;
          } else {
            likeBtn.textContent = `üíô ${msg.likes}`;
          }

          footer.appendChild(likeBtn);
          wrapper.appendChild(textDiv);
          wrapper.appendChild(footer);

          chatBox.appendChild(wrapper);
        });

        filterMessages(currentSearchTerm);
        chatBox.scrollTop = chatBox.scrollHeight;
      } catch (err) {
        console.error("Erro ao carregar mensagens:", err);
      }
    }



    // Filtrar mensagens ‚Äî recebe termo j√° normalizado
    function filterMessages(normalizedTerm) {
      const mensagens = chatBox.getElementsByClassName("msg");
      for (let msg of mensagens) {
        const txtEl = msg.querySelector(".msg-text");
        // fallback robusto
        const raw = txtEl ? txtEl.innerText || txtEl.textContent : msg.textContent || "";
        const normalized = normalizeText(raw);
        if (!normalizedTerm || normalized.includes(normalizedTerm)) {
          msg.classList.remove("hidden");
        } else {
          msg.classList.add("hidden");
        }
      }
    }

    // Enviar mensagem
    chatForm.addEventListener("submit", async function (e) {
      e.preventDefault();
      const texto = inputMensagem.value.trim();
      if (!texto) return;
      try {
        await fetch("/messages", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: texto })
        });
        inputMensagem.value = "";
        await carregarMensagens();
        // reaplicar filtro
        filterMessages(currentSearchTerm);
        carregarRanking();
      } catch (err) {
        console.error("Erro ao enviar mensagem:", err);
      }
    });

    // Pesquisa: submit e input (ao digitar)
    searchForm.addEventListener("submit", function (e) {
      e.preventDefault();
      currentSearchTerm = normalizeText(inputPesquisa.value.trim());
      filterMessages(currentSearchTerm);
    });
    inputPesquisa.addEventListener("input", function () {
      currentSearchTerm = normalizeText(inputPesquisa.value.trim());
      filterMessages(currentSearchTerm);
    });

    // Evento de like (delegation)
    chatBox.addEventListener("click", async (e) => {
      const btn = e.target.closest(".like-btn");
      if (!btn) return;

      const id = btn.dataset.id;
      try {
        const resp = await fetch(`/like/${id}`, { method: "POST" });
        const data = await resp.json();

        if (data.status === "success") {
          // curtir
          btn.textContent = `‚ù§Ô∏è ${data.likes}`;
          btn.classList.add("already-liked");
        } else if (data.status === "undone") {
          // desfazer like
          btn.textContent = `üíô ${data.likes}`;
          btn.classList.remove("already-liked");
        } else {
          mostrarErro(data.message || "Erro ao curtir!");
        }

        // atualizar ranking
        carregarRanking();
      } catch (err) {
        mostrarErro("Erro ao curtir: " + err.message);
      }
    });



    function mostrarErro(msg) {
      const container = document.getElementById("feedback-container");
      container.textContent = msg;
      container.style.display = "block";
      setTimeout(() => {
        container.style.display = "none";
      }, 2500); // desaparece ap√≥s 2,5s
    }


    // Carregar ranking (top 5) com formata√ß√£o de links
    async function carregarRanking() {
      try {
        const resp = await fetch("/top-messages");
        const dados = await resp.json();
        rankingList.innerHTML = "";
        dados.forEach(m => {
          const li = document.createElement("li");
          li.innerHTML = `${formatarMensagem(m.text)} <span class="likes">‚ù§Ô∏è ${m.likes}</span>`;
          rankingList.appendChild(li);
        });
      } catch (err) {
        console.error("Erro ao carregar ranking:", err);
      }
    }

    // Inicializa√ß√£o
    (async function init() {
      await carregarMensagens();
      await carregarRanking();
      // manter foco no campo de busca em ambientes de teste (opcional)
      // inputPesquisa.focus();
    })();
  </script>

  <div id="feedback-container">Erro
  </div>
</body>

</html>

</html>